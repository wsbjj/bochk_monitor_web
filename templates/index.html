<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>中银香港预约监控</title>
  <link rel="icon" href="{{ url_for('favicon') }}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    .navbar { background-color: #0f2d52 !important; }
    .navbar-brand { font-weight: bold; font-size: 1.3rem; }
    .card { border-radius: 0.5rem; border: 1px solid #dee2e6; }
    .card-header { background-color: #f8f9fa; border-bottom: 1px solid #dee2e6; font-weight: 600; }
    .status-badge { display: inline-block; padding: 0.4rem 0.8rem; border-radius: 0.25rem; font-size: 0.9rem; }
    .status-running { background-color: #d4edda; color: #155724; }
    .status-stopped { background-color: #f8d7da; color: #721c24; }
    .date-input-group { display: flex; gap: 0.5rem; }
    .date-input-group input { flex: 1; }
    .date-input-group button { white-space: nowrap; }
  </style>
  <script>
    function populateNext7Days() {
      fetch('/api/next-7-days')
        .then(r => r.json())
        .then(data => {
          document.getElementById('check_dates').value = data.dates.join(',');
          document.getElementById('monitor_all_checkbox').checked = false;
        })
        .catch(err => alert('获取失败: ' + err));
    }
    
    function toggleMonitorAll() {
      const checkbox = document.getElementById('monitor_all_checkbox');
      const input = document.getElementById('check_dates');
      if (checkbox.checked) {
        input.value = ''; // Clear input when "All" is selected
      }
    }

    function onDateInput() {
      const input = document.getElementById('check_dates');
      const checkbox = document.getElementById('monitor_all_checkbox');
      if (input.value.trim() !== '') {
        checkbox.checked = false; // Uncheck "All" when user types
      }
    }
  </script>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">中银香港预约监控</a>
    </div>
  </nav>

  <div class="container-fluid mt-4" style="max-width: 1000px;">
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- Status Card -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">监控状态</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-4 mb-3">
            <p class="mb-1"><strong>运行状态:</strong></p>
            <span class="status-badge {% if state.running %}status-running{% else %}status-stopped{% endif %}">
              {{ '运行中' if state.running else '已停止' }}
            </span>
          </div>
          <div class="col-md-4 mb-3">
            <p class="mb-1"><strong>轮询间隔:</strong> <span class="text-muted">{{ state.interval_seconds }} 秒</span></p>
            <p class="mb-0"><strong>上次检查:</strong> <span class="text-muted">{{ state.last_checked_at or '无' }}</span></p>
          </div>
          <div class="col-md-4 mb-3">
            <p class="mb-0"><strong>eaiCode:</strong> <span class="text-muted">{{ state.last_eai_code or '无' }}</span></p>
            <p class="mb-0"><strong>历史记录:</strong> <span class="text-muted">{{ state.history | length }} 条</span></p>
          </div>
        </div>

        <div class="row mt-3">
          <div class="col-md-6 mb-3">
            <p class="mb-1"><strong>可预约情况:</strong></p>
            <p class="text-success mb-0">
              <span class="badge bg-success">{{ state.last_available_num }} 个可预约</span>
            </p>
            {% if state.last_available_list %}
              <small class="text-muted d-block mt-2">日期: {{ state.last_available_list | join(', ') }}</small>
            {% endif %}
          </div>
          <div class="col-md-6 mb-3">
            <p class="mb-1"><strong>最近错误:</strong></p>
            <p class="text-danger mb-0">
              {% if state.last_error %}
                <span class="text-truncate d-block" title="{{ state.last_error }}">{{ state.last_error }}</span>
              {% else %}
                <span class="text-muted">无</span>
              {% endif %}
            </p>
          </div>
        </div>

        <!-- Recent History Table -->
        <div class="mt-4">
          <h6 class="border-bottom pb-2 mb-3">最近运行日志 (最新10条)</h6>
          <div class="table-responsive">
            <table class="table table-sm table-hover" style="font-size: 0.9rem;">
              <thead class="table-light">
                <tr>
                  <th scope="col" style="width: 30%">检查时间</th>
                  <th scope="col" style="width: 20%">状态</th>
                  <th scope="col" style="width: 20%">可预约数</th>
                  <th scope="col" style="width: 30%">备注</th>
                </tr>
              </thead>
              <tbody>
                {% for entry in state.history | reverse | list | batch(10) | first or [] %}
                <tr>
                  <td>{{ entry.checked_at }}</td>
                  <td>
                    {% if entry.error %}
                      <span class="badge bg-danger">错误</span>
                    {% elif entry.eai_code == 'SUCCESS' %}
                      <span class="badge bg-success">成功</span>
                    {% else %}
                      <span class="badge bg-secondary">{{ entry.eai_code or '未知' }}</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if entry.available_num is not none %}
                      {% if entry.available_num > 0 %}
                        <strong class="text-success">{{ entry.available_num }}</strong>
                      {% else %}
                        <span class="text-muted">0</span>
                      {% endif %}
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  <td>
                    {% if entry.error %}
                      <span class="text-danger small text-truncate d-block" style="max-width: 200px;" title="{{ entry.error }}">{{ entry.error }}</span>
                    {% elif entry.available_num > 0 %}
                      <span class="text-success small">{{ entry.available_list | join(', ') }}</span>
                    {% else %}
                      <span class="text-muted small">-</span>
                    {% endif %}
                  </td>
                </tr>
                {% else %}
                <tr>
                  <td colspan="4" class="text-center text-muted">暂无记录</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <div class="mt-3">
          {% if state.running %}
            <form action="{{ url_for('stop_monitor') }}" method="post" style="display: inline;">
              <button class="btn btn-danger btn-sm" type="submit">停止监控</button>
            </form>
          {% else %}
            <form action="{{ url_for('start_monitor') }}" method="post" style="display: inline;">
              <button class="btn btn-success btn-sm" type="submit">开始监控</button>
            </form>
          {% endif %}
          <a href="{{ url_for('history') }}" class="btn btn-info btn-sm">查看历史</a>
        </div>
      </div>
    </div>

    <!-- Configuration Card -->
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">监控配置</h5>
      </div>
      <div class="card-body">
        <form action="{{ url_for('update_config') }}" method="post">
          <!-- Monitor Dates Section -->
          <div class="mb-4">
            <h6 class="mb-3">关注日期（邮件通知规则）</h6>
            
            <div class="mb-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="monitor_all_checkbox" 
                       name="monitor_all" {% if 'all' in state.check_dates %}checked{% endif %}
                       onchange="toggleMonitorAll()">
                <label class="form-check-label" for="monitor_all_checkbox">
                  接收所有日期的邮件通知
                </label>
              </div>
              <small class="text-muted d-block mt-2">
                启用后，任何有号的日期都会触发邮件通知。系统始终会监控并记录所有日期的状态。
              </small>
            </div>

            <div class="mb-3">
              <label for="check_dates" class="form-label">或仅关注具体日期 (YYYYMMDD格式，用逗号分隔)</label>
              <div class="date-input-group">
                <input id="check_dates" type="text" class="form-control" name="check_dates" 
                       value="{% if 'all' not in state.check_dates %}{{ state.check_dates | join(',') }}{% endif %}"
                       oninput="onDateInput()"
                       placeholder="例如：20260213,20260214,20260215">
                <button type="button" class="btn btn-outline-secondary" onclick="populateNext7Days()">未来7天</button>
              </div>
              <small class="text-muted d-block mt-2">在此输入日期后，将仅针对这些日期发送邮件通知（"接收所有"选项会自动取消）</small>
            </div>
          </div>

          <!-- Interval Section -->
          <div class="mb-4">
            <h6 class="mb-3">轮询设置</h6>
            <div class="row">
              <div class="col-md-6">
                <label for="interval_seconds" class="form-label">轮询间隔（秒）</label>
                <input id="interval_seconds" type="number" class="form-control" min="10" 
                       name="interval_seconds" value="{{ state.interval_seconds }}"
                       placeholder="60">
              </div>
              <div class="col-md-6">
                <div class="form-check mt-4">
                  <input class="form-check-input" type="checkbox" id="notify_on_available" 
                         name="notify_on_available" {% if state.notify_on_available %}checked{% endif %}>
                  <label class="form-check-label" for="notify_on_available">
                    有可预约时发送邮件通知
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- Email Configuration Section -->
          <div class="mb-4">
            <h6 class="mb-3">邮件配置</h6>
            <div class="alert alert-info" role="alert">
              <small>
                <strong>支持的邮箱服务商：</strong>
                163 (smtp.163.com) • QQ (smtp.qq.com) • Gmail (smtp.gmail.com) • Outlook (smtp-mail.outlook.com) • Office365 (smtp.office365.com)
              </small>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="mail_host" class="form-label">SMTP 服务器</label>
                <input id="mail_host" type="text" class="form-control" name="mail_host" 
                       value="{{ email.mail_host }}" placeholder="smtp.qq.com">
              </div>
              <div class="col-md-6 mb-3">
                <label for="mail_port" class="form-label">SMTP 端口 <span class="text-muted">(可选)</span></label>
                <input id="mail_port" type="number" class="form-control" name="mail_port" 
                       value="{{ email.mail_port or '' }}" placeholder="自动检测（465 或 587）"
                       min="1" max="65535">
                <small class="text-muted d-block mt-1">留空为自动检测。QQ/Gmail: 465，Outlook/Office365: 587</small>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="mail_user" class="form-label">SMTP 用户名</label>
                <input id="mail_user" type="text" class="form-control" name="mail_user" 
                       value="{{ email.mail_user }}" placeholder="user@example.com 或 QQ号">
              </div>
              <div class="col-md-6 mb-3">
                <label for="mail_pass" class="form-label">SMTP 授权码</label>
                <input id="mail_pass" type="password" class="form-control" name="mail_pass" 
                       value="{{ email.mail_pass }}" placeholder="授权码（不是密码）">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="sender" class="form-label">发件人邮箱</label>
                <input id="sender" type="text" class="form-control" name="sender" 
                       value="{{ email.sender }}" placeholder="your@example.com">
              </div>
              <div class="col-md-6 mb-3">
                <label for="receivers" class="form-label">收件人邮箱</label>
                <input id="receivers" type="text" class="form-control" name="receivers" 
                       value="{{ email.receivers }}" placeholder="recipient1@example.com,recipient2@example.com">
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="d-flex gap-3 mt-4">
            <button class="btn btn-primary px-4" type="submit">保存配置</button>
            <button class="btn btn-warning px-4" type="submit" formaction="{{ url_for('test_email') }}">发送测试邮件</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <footer class="text-center text-muted mt-5 mb-4">
    <small>中银香港预约监控系统 v1.0</small>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Auto-refresh logic (every 60 seconds)
    // Only refresh if user is not interacting with the form
    let isInteracting = false;
    document.querySelectorAll('input, select, textarea').forEach(el => {
      el.addEventListener('focus', () => isInteracting = true);
      el.addEventListener('blur', () => isInteracting = false);
    });

    setInterval(() => {
      if (!isInteracting) {
        window.location.reload();
      }
    }, 60000);

    // Initialize monitor_all state on load
    document.addEventListener('DOMContentLoaded', function() {
      // Ensure UI consistency if needed
    });
  </script>
</body>
</html>
